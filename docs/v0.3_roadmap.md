# CarthEdge v0.3 Roadmap (SDK) — QKeyRotation-governed Double Ratchet

## Scope (non-negotiable)
- Full Signal-like Double Ratchet layer (X25519 DH ratchet + symmetric chains).
- **All ratchet state transitions are gated by QKeyRotationV1** (policy + recovery).
- **All sensitive ops require op_context binding** (header/AAD + QKR op_context).
- **Replay protection explicit + testable** (counters + skipped-keys window + dedupe).
- Offline-first, deterministic tests. No mobile/UI.

---

## v0.3.0 — Spec + State Skeleton (this checkpoint)
**Goal:** Freeze the ratchet spec + state invariants + public hooks signatures.
Deliverables:
- docs/ratchet_spec.md (design + state machine + failure modes)
- pkg/ratchet/state.go (state struct + invariants + validation helpers)
- docs/v0.3_roadmap.md (this file)

Acceptance:
- `go test ./...` passes offline (even if no ratchet tests yet)
- Spec explicitly defines:
  - send/recv chains, root-key evolution
  - replay protection & skipped keys window
  - QKeyRotation gating points + op_context binding rules
  - integration with EnvelopeV2 header/AAD

---

## v0.3.1 — Root/Chain Key Derivations + QKR-gated Steps
**Goal:** Implement deterministic key schedule with clear transition rules.
Deliverables:
- pkg/ratchet/kdf.go (HKDF-based derivations; domain separation labels)
- pkg/ratchet/step_send.go (ratchet_step_send, QKR-gated)
- pkg/ratchet/step_recv.go (ratchet_step_recv, QKR-gated)
- pkg/ratchet/opctx.go (canonical op_context builder; stable serialization)

Acceptance:
- Offline unit tests:
  - deterministic vectors for KDF outputs (fixed seeds)
  - step_send increments Ns and yields message key
  - step_recv handles same-chain messages and advances Nr
- All KDF labels are documented and stable.

---

## v0.3.2 — EnvelopeV2 Integration + decrypt_msg + Replay Protection
**Goal:** Bind ratchet to EnvelopeV2 and enforce replay defenses.
Deliverables:
- pkg/ratchet/envelope_v2.go (header/AAD binding rules; encode/decode helpers)
- pkg/ratchet/decrypt.go (decrypt_msg, QKR-gated)
- pkg/ratchet/replay.go (skipped keys store; counters; dedupe; pruning)

Acceptance (offline tests):
- normal flow (A<->B, mixed send/recv)
- replay attack (duplicate ciphertext rejected deterministically)
- skipped keys (out-of-order within window accepted once)
- strict header/AAD binding (tamper fails)

---

## v0.3.3 — Desync + Forced Recovery (Policy Block) + Introspection
**Goal:** Robust failure modes + explicit recovery under QKR policy.
Deliverables:
- pkg/ratchet/recovery.go (policy-driven forced recovery path; state reset rules)
- pkg/ratchet/introspect.go (explicit introspection states + reason codes)
- test suite:
  - state desync (drop/duplicate/out-of-order beyond window) -> deterministic failure
  - forced recovery via policy block -> deterministic transition + reason

Acceptance:
- All tests offline + fast (no sleeps, no network, deterministic RNG injected)
- Introspection outputs are stable and machine-readable.

---

## Tagging & release discipline
- v0.3.0, v0.3.1, v0.3.2, v0.3.3 are **semantic tags**.
- Each checkpoint must include:
  - checklist (done/verified)
  - `go test ./...` output clean offline
  - commit message prefix: `feat(v0.3.x): ...` or `docs(v0.3.x): ...`

